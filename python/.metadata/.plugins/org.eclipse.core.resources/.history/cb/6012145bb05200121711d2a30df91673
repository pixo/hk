#!/usr/bin/env python
import couchdb
import argparse
import os,time

def zzFS_getRoot():
    return "/works/projects"
    
def createProjectDefaultModules(projectName):
    root = zzFS_getRoot()
    projectPath = "%s/%s" % (root,name)
    if os.path.exists(projectPath): 
        os.makedirs("%s/code/modules" % projectPath, mode = 0775) 
        print "Project %s created : %s" % (name, projectPath)
    
def createProjectOnFS(name):
    root = zzFS_getRoot()
    projectPath = "%s/%s" % (root,name)
    if not os.path.exists(projectPath): 
        os.makedirs(projectPath, mode = 0775) 
        print "Project %s created : %s" % (name, projectPath)

def createProjectOnDB(name,db):
    doc = {
    "_id": "project_%s" % name,
    "type": "project",
    "name": name,
    "creator": os.getenv("USER"),
    "created": time.strftime("%Y %b %d %H:%M:%S", time.gmtime())
    }
    _id, _rev = db.save(doc)
    print "Project %r created as Document(%r)" % (name, _id)
        
def createProject(name,db):
    createProjectOnDB(name,db)
    createProjectOnFS(name)

if __name__ == '__main__':#terminal
    dbname="db1"
    user="admin:admin"
    server = couchdb.Server("http://%s@127.0.0.1:5984" % user)
    
    if dbname in server:
        db = server[dbname]
        parser = argparse.ArgumentParser()
        parser.add_argument("name", help="name of the project to create")
        args = parser.parse_args()
        
        try :
            createProject(args.name,db)
    
        except couchdb.ResourceConflict:#Project already exist
            print 'Project "%s" already exist' % args.name
            
    else :
        print """Database "%s" doesn't exist""" % dbname
    

