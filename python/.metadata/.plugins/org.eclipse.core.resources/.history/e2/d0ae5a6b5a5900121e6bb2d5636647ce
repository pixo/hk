'''
Created on Jan 8, 2013

@author: pixo
'''

import os, time, shutil

def pull(db, entity_id, version="latest"):
    """Get the data from the repository """
    entity_doc = db[entity_id]
    entity_version_attr = entity_doc["version"]

    if version == "latest":
        version = len(entity_version_attr)
        
    source_path = entity_version_attr[str(version)]["path"]
    destination_path=source_path.replace ( "$HK_REPOSITORY_PATH", "$HK_USER_REPOSITORY_PATH" )
    
    source_path = os.path.expandvars(source_path)
    destination_path=os.path.expandvars(destination_path)
    
    print "done"

def push(db, entity_id, source_file,comments):
        
    """Put the data into the repository """
    entity_doc = db[entity_id]
    entity_version_attr = entity_doc["version"]
    version = len(entity_version_attr)+1
        
    push_path = entity_id [ len ( "%s_" % os.getenv( "HK_PROJECT" ) ) : ]    #remove the project name from the entity_id
    push_path = push_path.replace ( "_", os.sep )
    push_path = os.path.join ( "$HK_REPOSITORY_PATH", entity_doc["inherit"], push_path, "v%03d" % version )
    push_file = entity_id + os.path.splitext ( source_file )[-1]
    push_full = os.path.join ( push_path, push_file )

    fileinfo = {"path":push_path,
                "files":1,
              "comments":comments,
              "creator":os.getenv("USER"),
              "created":time.strftime("%Y %b %d %H:%M:%S", time.gmtime())}
    entity_version_attr[version] = fileinfo
    entity_doc["version"] = entity_version_attr
    
    push_path = os.path.expandvars ( push_path )
    push_full = os.path.expandvars ( push_full )
    
    if os.path.exists(source_file) and (not os.path.exists(push_path)):
        os.makedirs(push_path, 0775)
        shutil.copyfile(source_file, push_full)
        if os.path.exists(push_full):
            db[entity_id] = entity_doc
            print("%s %s" % ("Published:",push_full))
    