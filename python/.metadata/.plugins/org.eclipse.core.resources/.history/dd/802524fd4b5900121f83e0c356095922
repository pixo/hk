'''
Created on Jan 8, 2013

@author: pixo
'''

import os, time, shutil

def pull(db, entity_id):
    """Get the data from the repository """
    
def push(db, entity_id, source_file):
    
    """Put the data into the repository """
    entity_doc = db[entity_id]
    entity_version_attr = entity_doc["version"]
    version=len(entity_version_attr)
    
    #Filesystem path
    #repository_path = os.getenv("HK_REPOSITORY_PATH")   
    project =  os.getenv("HK_PROJECT")
    
    push_path = entity_id[len("%s_" % project):]    #remove the project name from the entity_id
    push_path = push_path.replace("_",os.sep)
    push_path = os.path.join("$HK_REPOSITORY_PATH", entity_doc["inherit"], push_path, "v%03d" % version)
    push_file = entity_id + os.path.splitext(source_file)[-1]
    push_full_path=os.path.join( push_path, push_file)

    entity_version_attr[version] = push_full_path
    entity_doc["version"] = entity_version_attr
    
    push_path=os.path.expandvars(push_path)
    push_full_path=os.path.expandvars(push_path)
    
    if os.path.exists(source_file) and (not os.path.exists(push_path)):
        os.makedirs(push_path, 0775)
        shutil.copyfile(source_file, push_full_path)
        if os.path.exists(push_full_path):
            db[entity_id] = entity_doc
    