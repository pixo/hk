'''
Created on Jan 6, 2013

@author: pixo
'''
import couchdb
import argparse
import os,time

def lsShots(db,project):
    startkey = u"project_%s_" % project
    endkey = u"project_%s_\u0fff" % project
    view = db.view("_design/%s/_view/shotsByProjectAndName" % db.name, startkey=startkey, endkey=endkey)
    shots = list()
    
    for row in view.rows:
        shots.append(row["value"]["name"])
        print row["value"]["name"]
    return shots 

def createShot(project, sequence, name, description, cut_in, cut_out, db):
    """string projectName, string shotName, string description, int cut_in, int cut_out, couch.db.Server db"""
    project_id = "project_%s" % project
    project_doc = db[project_id]
    shots = project_doc.setdefault("shots", {}) 
    shotslist = lsShots(db, project)
    
    if not (name in shotslist) :
        shot_doc = {
            "type": "shot",
            "_id": "%s_shot_%s" % (project_doc["_id"], name),
            "name": name,
            "project_id": project_id,
            "description": description,
            "cut_in": cut_in,
            "cut_out":cut_out,
            "creator": os.getenv("USER"),
            "created": time.strftime("%Y %b %d %H:%M:%S", time.gmtime())
        }
        
        _id, _rev = db.save(shot_doc)
        return True
        print "createShot: Added shot %r to project %r" % (name, project)
    else:
        print "createShot: Shot %s already exist" % name