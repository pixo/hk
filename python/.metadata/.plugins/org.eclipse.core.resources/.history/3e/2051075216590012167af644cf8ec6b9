'''
Created on Jan 7, 2013

@author: pixo
'''
import os, time

import couchdb.mapping as mapping

def lsShotTask(db, shot_id="",task=""):
    startkey = u"%s_" % (shot_id)
    endkey = u"%s_\u0fff" % ( shot_id)
    view = db.view("_design/%s/_view/%ssByProjectAndName" % ("cg_project",task), startkey=startkey, endkey=endkey)
    tasks = list()
    
    for row in view.rows:
        tasks.append(row["value"]["name"])
        print row["value"]["name"]
    return tasks

def createShotTask(project, sequence, shot, name, description, db):
    """string projectName, string shotName, string description, int cut_in, int cut_out, couch.db.Server db"""
    project_id = "%s" % project
    sequence_id = "%s_%s" % (project_id, sequence)
    shot_id = "%s_%s" % (sequence_id, shot)
    task_id = "%s_%s" % (shot_id, name)
    
    shot_doc = db[shot_id]
    tasks = shot_doc.setdefault(name, {}) 
    taskslist = lsShotTask(db, shot, name)
    
    if not ( name in taskslist ) :
        task_doc = {
            "type": name,
            "_id": "%s_%s" % (shot_id, name),
            "project_id": project_id,
            "sequence_id": sequence_id,
            "shot_id": shot_id,
            "name": "%s_%s" % (shot, name),
            "description": description,
            "version": {1:"caca",2:"pipi"}
            "creator": os.getenv("USER"),
            "created": time.strftime("%Y %b %d %H:%M:%S", time.gmtime())
        }
        
        _id, _rev = db.save(task_doc)
        print "createShotTask: Added %r_%r to project %r" % (shot, name , project)
        return True
    
    else:
        print "createShotTask: Shot %s already exist" % (shot, name)
        return False